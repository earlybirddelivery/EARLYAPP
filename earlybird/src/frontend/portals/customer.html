<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarlyBird Customer - My Account</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/subscription-integration.css">
</head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üåÖ</div>
                    <div class="logo-text">
                        <h1>EarlyBird</h1>
                        <p>Customer Portal</p>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <!-- CALENDAR IS THE SPINE - PRIMARY INTERFACE -->
                <div class="nav-item active" data-page="calendar" onclick="showPage('calendar')">
                    <span class="nav-icon">üìÖ</span>
                    <span>üìÖ MY CALENDAR</span>
                </div>

                <div style="margin: 12px 20px; height: 1px; background: var(--border);"></div>
                <div style="padding: 12px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary);">Quick Access</div>

                <div class="nav-item" data-page="orders" onclick="showPage('orders')">
                    <span class="nav-icon">ÔøΩ</span>
                    <span>Subscriptions & Orders</span>
                </div>
                <div class="nav-item" data-page="monthlylist" onclick="showPage('monthlylist')">
                    <span class="nav-icon">üìù</span>
                    <span>Monthly List</span>
                </div>
                <div class="nav-item" data-page="wallet" onclick="showPage('wallet')">
                    <span class="nav-icon">üí∞</span>
                    <span>Wallet</span>
                </div>
                <div class="nav-item" data-page="ledger" onclick="showPage('ledger')">
                    <span class="nav-icon">üìä</span>
                    <span>Ledger</span>
                </div>
                <div class="nav-item" data-page="sharedaccess" onclick="showPage('sharedaccess'); sharedAccessUI.init()">
                    <span class="nav-icon">üë•</span>
                    <span>Account Access</span>
                </div>

                <div style="margin: 12px 20px; height: 1px; background: var(--border);"></div>
                <div style="padding: 12px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary);">Smart Features</div>
                <div class="nav-item" data-page="voiceOrder" onclick="showPage('voiceOrder'); phase3UI.initVoiceOrderUI()">
                    <span class="nav-icon">üé§</span>
                    <span>Voice Order</span>
                </div>
                <div class="nav-item" data-page="ocr" onclick="showPage('ocr'); phase3UI.initOCRUI()">
                    <span class="nav-icon">üì∏</span>
                    <span>OCR Upload</span>
                </div>
                <div class="nav-item" data-page="smartFeatures" onclick="showPage('smartFeatures'); phase3UI.initSmartFeaturesUI()">
                    <span class="nav-icon">‚ú®</span>
                    <span>Smart Features</span>
                </div>
                <div class="nav-item" data-page="analytics" onclick="showPage('analytics'); phase3UI.initAnalyticsUI()">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </div>
            </nav>

            <div style="padding: 20px; border-top: 1px solid var(--border); margin-top: auto;">
                <div style="background: linear-gradient(135deg, #F77F00 0%, #DC6803 100%); color: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Wallet Balance</div>
                    <div style="font-size: 24px; font-weight: 700;">‚Çπ1,250</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Advance credit available</div>
                </div>
                <div class="user-info" style="margin-bottom: 12px; padding: 12px; background: var(--light); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Logged in as</div>
                    <div class="user-name" style="font-weight: 600; color: var(--primary);">Customer</div>
                </div>
                <button class="btn btn-outline" style="width: 100%;" onclick="EarlyBirdAuth.logout(); window.location.href='login.html'">
                    üö™ Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Calendar Page -->
            <div id="calendarPage" class="page-content">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìÖ My Calendar</h2>
                        <p>Your personal delivery and payment schedule</p>
                    </div>
                </div>

                <div class="heat-map-legend">
                    <span class="legend-title">My Activity</span>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="indicator delivery" style="width: 12px; height: 12px;"></div>
                            <span>Delivery</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator payment" style="width: 12px; height: 12px;"></div>
                            <span>Payment</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator order" style="width: 12px; height: 12px;"></div>
                            <span>Order</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator subscription" style="width: 12px; height: 12px;"></div>
                            <span>Subscription</span>
                        </div>
                    </div>
                </div>

                <div class="calendar-layout">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <h3 class="calendar-month-title" id="calendarMonthTitle"></h3>
                            <div class="calendar-nav">
                                <button onclick="changeMonth(-1)">‚óÄ Previous</button>
                                <button onclick="changeMonth(0)">Today</button>
                                <button onclick="changeMonth(1)">Next ‚ñ∂</button>
                            </div>
                        </div>
                        <div id="calendarGrid"></div>
                    </div>
                    
                    <div class="date-detail-view" id="dateDetailView">
                        <!-- Date details will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìä Your Account Overview</h2>
                        <p>Manage your subscriptions (primary) and orders (ad-hoc)</p>
                    </div>
                </div>

                <!-- Subscription-First Focus -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 12px; border-left: 4px solid var(--primary);">
                        <div style="font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 4px;">üîÑ SUBSCRIPTIONS (Core Service)</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">Recurring Deliveries</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Set it once, get regular deliveries automatically</div>
                    </div>
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%); border-radius: 12px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 12px; font-weight: 700; color: #2e7d32; margin-bottom: 4px;">üì¶ ORDERS (Ad-hoc)</div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">One-Time Purchases</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Need something extra? Order anytime</div>
                    </div>
                </div>

                <div class="stat-grid">
                    <div class="stat-card primary">
                        <div class="stat-label">Active Subscriptions</div>
                        <div class="stat-value">3</div>
                        <div class="stat-change">Milk, Water, Bread (PRIMARY)</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">This Month's Orders</div>
                        <div class="stat-value">8</div>
                        <div class="stat-change">4 pending delivery</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Wallet Balance</div>
                        <div class="stat-value">‚Çπ1,250</div>
                        <div class="stat-change">Advance credit</div>
                    </div>
                    <div class="stat-card secondary">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value">‚Çπ0</div>
                        <div class="stat-change">All paid!</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button class="btn btn-primary" onclick="showPage('orders'); switchSubscriptionTab('subscriptions')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 700;">üîÑ Manage Subscriptions</button>
                        <button class="btn btn-primary" onclick="EarlyBirdUIComponents.openCreateOrderModal()">üì¶ Create Order</button>
                        <button class="btn btn-primary" onclick="EarlyBirdUIComponents.openTopUpWalletModal()">üí∞ Top Up Wallet</button>
                        <button class="btn btn-primary" onclick="document.getElementById('ledgerPage').innerHTML = EarlyBirdUIComponents.renderLedger(); showPage('ledger')">üìù View Ledger</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 16px;">Your Exclusive Payment Link</h3>
                    <div style="background: var(--light); padding: 16px; border-radius: 8px;">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                            Use this link for all subscription & order payments. Save it in your UPI app!
                        </div>
                        <div style="font-family: monospace; background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; word-break: break-all;">
                            pay.earlybird.app/c/Rx8kL3mN
                        </div>
                        <button class="btn btn-outline">üìã Copy Link</button>
                    </div>
                </div>
            </div>

            <!-- Orders Page -->
            <div id="ordersPage" class="page-content" style="display: none;">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border); padding-bottom: 0;">
                    <button class="btn-tab active" onclick="switchSubscriptionTab('subscriptions')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; flex-shrink: 0;" id="tab-subscriptions">
                        üîÑ My Subscriptions (Primary)
                    </button>
                    <button class="btn-tab" onclick="switchSubscriptionTab('orders')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; flex-shrink: 0;" id="tab-orders">
                        üì¶ Order History (Ad-hoc)
                    </button>
                </div>

                <!-- SUBSCRIPTIONS TAB (PRIMARY) -->
                <div id="subscriptionsTabContent" style="display: block;">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h2>üîÑ My Subscriptions</h2>
                            <p>Manage your recurring deliveries (Core service)</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="subscriptionIntegration.showCreateSubscriptionModal()">üîÑ Add Subscription</button>
                            <button class="btn btn-success" onclick="subscriptionIntegration.showCustomerInfo()">üë§ View Profile</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="border-left: 4px solid var(--primary); padding: 20px; margin-bottom: 16px; background: var(--light); border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">Milk 500ml - Daily</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                                Delivery: Every day at 6:00 AM ‚Ä¢ ‚Çπ25/day
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-outline" onclick="subscriptionIntegration.pauseSubscription('SUB001')">‚è∏Ô∏è Pause</button>
                                <button class="btn btn-sm btn-outline" onclick="subscriptionIntegration.showCreateSubscriptionModal()">‚úèÔ∏è Edit</button>
                            </div>
                        </div>

                        <div style="border-left: 4px solid var(--secondary); padding: 20px; margin-bottom: 16px; background: var(--light); border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">Water Can 20L - Weekly</div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                                Delivery: Every Monday ‚Ä¢ ‚Çπ60/week
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-outline" onclick="subscriptionIntegration.resumeSubscription('SUB002')">‚ñ∂Ô∏è Resume</button>
                                <button class="btn btn-sm btn-outline" onclick="subscriptionIntegration.showCreateSubscriptionModal()">‚úèÔ∏è Edit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ORDERS TAB (SECONDARY) -->
                <div id="ordersTabContent" style="display: none;">
                    <div class="page-header">
                        <div class="page-header-left">
                            <h2>üì¶ Order History</h2>
                            <p>One-time purchases and ad-hoc orders</p>
                        </div>
                        <button class="btn btn-primary" onclick="subscriptionIntegration.showCreateOrderModal()">üì¶ Create Order</button>
                    </div>
                    <div class="card">
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 16px; background: var(--light); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 15px;">Order #ORD001</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Jan 20, 2026</div>
                                    </div>
                                    <div style="background: var(--success); color: white; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 700;">DELIVERED</div>
                                </div>
                                <div style="font-size: 13px; margin-bottom: 8px;">2 items ‚Ä¢ ‚Çπ450</div>
                                <button class="btn btn-sm btn-outline" onclick="EarlyBirdUtils.showToast('Reorder functionality coming soon', 'info')">üîÑ Reorder</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly List Page -->
            <div id="monthlylistPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìù Monthly List</h2>
                        <p>Smart month-to-month comparison with auto-carry forward</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline btn-sm" onclick="monthlyListUI.copyFromLastMonth()">
                            üìã Copy Last Month
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="monthlyListUI.createOrderFromList()">
                            ‚úÖ Create Order
                        </button>
                    </div>
                </div>

                <!-- Month Navigation -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; background: #f9fafb; padding: 12px 16px; border-radius: 8px;">
                    <button class="btn btn-sm btn-outline" onclick="monthlyListUI.previousMonth()">‚óÄ Previous</button>
                    <div style="flex: 1; text-align: center; font-weight: 600;" id="monthDisplay">January 2025</div>
                    <button class="btn btn-sm btn-outline" onclick="monthlyListUI.nextMonth()">Next ‚ñ∂</button>
                    <button class="btn btn-sm btn-outline" onclick="monthlyListUI.currentMonth()">Today</button>
                </div>

                <!-- Smart Diff View Toggle -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-outline btn-sm" id="listViewBtn" onclick="monthlyListUI.switchView('list')" style="background: var(--primary); color: white; border-color: var(--primary);">
                        üìã List View
                    </button>
                    <button class="btn btn-outline btn-sm" id="diffViewBtn" onclick="monthlyListUI.switchView('diff')">
                        üîÑ Compare
                    </button>
                </div>

                <!-- List View -->
                <div id="listViewContent">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="productSearch" placeholder="Search products..." 
                            style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px;"
                            onkeyup="monthlyListUI.filterProducts()">
                        <button class="btn btn-primary btn-sm" onclick="monthlyListUI.openAddItemModal()">‚ûï Add Item</button>
                    </div>

                    <div id="listContent" style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <div class="empty-state" style="grid-column: 1;">
                            <div class="empty-state-icon">üìù</div>
                            <h3>Your list is empty</h3>
                            <p>Start by adding items or copying from last month</p>
                            <button class="btn btn-primary mt-2" onclick="monthlyListUI.copyFromLastMonth()">
                                Copy from Last Month
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Diff View -->
                <div id="diffViewContent" style="display: none;">
                    <div id="diffContent"></div>
                </div>

                <!-- Insights Section -->
                <div id="insightsSection" style="display: none; margin-top: 24px;">
                    <h3 style="margin-bottom: 12px;">üí° Monthly Insights</h3>
                    <div id="insightsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                    </div>
                </div>

                <!-- Monthly History Chart -->
                <div style="margin-top: 24px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="margin-bottom: 12px;">üìä Your Order History</h3>
                    <div id="historyChart" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>

            <!-- Wallet Page -->
            <div id="walletPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üí∞ My Wallet</h2>
                        <p>Your payment wallet and transactions</p>
                    </div>
                </div>
                <div class="card">
                    <div style="background: linear-gradient(135deg, #F77F00 0%, #DC6803 100%); color: white; padding: 32px; border-radius: 12px; margin-bottom: 24px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Current Balance</div>
                        <div style="font-size: 48px; font-weight: 700; margin-bottom: 16px;" data-widget="wallet-balance">‚Çπ1,250</div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="EarlyBirdUIComponents.openTopUpWalletModal()">
                                üí≥ Top Up
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="showPage('ledger')">
                                üìä History
                            </button>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 16px;">Recent Transactions</h3>
                    <div id="recentTransactions">
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">Payment Received</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Jan 20, 2026</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--success);">+‚Çπ2,000</div>
                            </div>
                        </div>
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">Grocery Order</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Jan 20, 2026</div>
                                </div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--danger);">-‚Çπ850</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ledger Page -->
            <div id="ledgerPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìä Financial Ledger</h2>
                        <p>Complete transaction history</p>
                    </div>
                    <button class="btn btn-outline" onclick="EarlyBirdUtils.showToast('Download feature coming soon', 'info')">üì• Download</button>
                </div>
                <div class="card">
                    <div id="ledgerContent"></div>
                </div>
            </div>

            <!-- Shared Access Page (Task 7) -->
            <div id="sharedaccessPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üë• Account Access</h2>
                        <p>Manage who has access to your account</p>
                    </div>
                </div>

                <!-- Current Participants Section -->
                <div class="card">
                    <h3 style="margin-bottom: 16px;">üë• Current Participants</h3>
                    <div id="participantsList" style="display: grid; gap: 12px;">
                        <!-- Populated by sharedAccessUI.init() -->
                    </div>
                </div>

                <!-- Pending Invitations -->
                <div class="card">
                    <h3 style="margin-bottom: 16px;">üì¨ Pending Invitations</h3>
                    <div id="invitationsList" style="display: grid; gap: 12px;">
                        <!-- Populated by sharedAccessUI.init() -->
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="card">
                    <h3 style="margin-bottom: 16px;">üìã Recent Activity (Who Did What)</h3>
                    <div id="auditTrail" style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">
                        <!-- Audit trail populated by sharedAccessUI.init() -->
                    </div>
                </div>

                <!-- Attribution Summary -->
                <div class="card">
                    <h3 style="margin-bottom: 16px;">üìä Activity Summary (Last 30 Days)</h3>
                    <div id="attributionSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <!-- Summary populated by sharedAccessUI.init() -->
                    </div>
                </div>
            </div>

            <!-- Phase 3: Voice Order Page -->
            <div id="voiceOrderPage" class="page-content" style="display: none;"></div>

            <!-- Phase 3: OCR Upload Page -->
            <div id="ocrPage" class="page-content" style="display: none;"></div>

            <!-- Phase 3: Smart Features Page -->
            <div id="smartFeaturesPage" class="page-content" style="display: none;"></div>

            <!-- Phase 3: Analytics Page -->
            <div id="analyticsPage" class="page-content" style="display: none;"></div>
        </main>
    </div>

    <!-- Phase 1-2: Core Modules -->
    <!-- Authentication Module -->
    <script src="../../backend/auth.js"></script>

    <!-- Backend Modules -->
    <script src="../../backend/utils.js"></script>
    <script src="../../backend/subscription.js"></script>
    <script src="../../backend/orders.js"></script>
    <script src="../../backend/delivery.js"></script>
    <script src="../../backend/wallet.js"></script>
    <script src="../../backend/payment-links.js"></script>
    <script src="../../backend/calendar.js"></script>
    <script src="../../backend/monthly-list.js"></script>

    <!-- Access Control (Role-based filtering) -->
    <script src="../../backend/access-control.js"></script>
    
    <!-- Shared Access (Multi-user collaboration with audit trail) -->
    <script src="../../backend/shared-access.js"></script>

    <!-- UI Components Module -->
    <script src="../components/ui-components.js"></script>

    <!-- Backend Processors -->
    <script src="../../backend/voice-processor.js"></script>
    <script src="../../backend/ocr-processor.js"></script>
    
    <!-- Phase 3: Intelligent Input & Smart Features -->
    <script src="../features/voice.js"></script>
    <script src="../features/image-ocr.js"></script>
    <script src="../features/smart-features.js"></script>

    <!-- Phase 3: Supplier Integration & Analytics -->
    <script src="../features/supplier.js"></script>
    <script src="../features/analytics.js"></script>

    <!-- Phase 3: Frontend UI Controller -->
    <script src="../features/phase3-ui.js"></script>

    <script>
        // ============================================
        // Monthly List UI Controller
        // ============================================
        const monthlyListUI = {
            state: {
                customerId: 'CUST_001',
                currentView: 'list', // 'list' or 'diff'
                selectedMonth: new Date()
            },

            init() {
                this.loadMonthlyList();
                this.renderHistory();
            },

            loadMonthlyList() {
                const month = EarlyBirdUtils.getMonthKey(this.state.selectedMonth);
                const list = EarlyBirdMonthlyList.getOrCreateMonthlyList(this.state.customerId, this.state.selectedMonth);
                
                // Update month display
                document.getElementById('monthDisplay').textContent = 
                    EarlyBirdUtils.formatDate(this.state.selectedMonth, 'month-year');
                
                if (this.state.currentView === 'list') {
                    this.renderListView(list);
                } else {
                    this.renderDiffView();
                }
            },

            renderListView(list) {
                const content = document.getElementById('listContent');
                
                if (!list.items || list.items.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <h3>Your list is empty</h3>
                            <p>Start by adding items or copying from last month</p>
                            <button class="btn btn-primary mt-2" onclick="monthlyListUI.copyFromLastMonth()">
                                üìã Copy from Last Month
                            </button>
                        </div>
                    `;
                    return;
                }

                let html = '';
                list.items.forEach(item => {
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 100px 80px 60px; gap: 12px; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div>
                                <div style="font-weight: 600;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${item.brand || 'No brand'}</div>
                            </div>
                            <div>
                                <input type="number" value="${item.quantity}" 
                                    onchange="monthlyListUI.updateQuantity('${item.productId}', this.value)"
                                    style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                            </div>
                            <div style="text-align: center; color: var(--text-secondary); font-size: 14px;">
                                ${item.unit}
                            </div>
                            <button class="btn btn-sm btn-outline" style="padding: 6px; width: 100%;" 
                                onclick="monthlyListUI.removeItem('${item.productId}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                });

                content.innerHTML = html;
            },

            renderDiffView() {
                const insights = EarlyBirdMonthlyList.getMonthlyInsights(this.state.customerId, this.state.selectedMonth);
                const diff = insights.diff;

                let html = `
                    <div style="margin-bottom: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                        <h3 style="margin-bottom: 12px;">üìä Monthly Comparison</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Last Month</div>
                                <div style="font-size: 20px; font-weight: 700; color: #667eea;">${diff.summary.totalLastMonth}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">items</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">This Month</div>
                                <div style="font-size: 20px; font-weight: 700; color: #667eea;">${diff.summary.totalThisMonth}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">items</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Change</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${diff.summary.totalThisMonth > diff.summary.totalLastMonth ? '#10b981' : '#ef4444'};">
                                    ${diff.summary.totalThisMonth > diff.summary.totalLastMonth ? '+' : ''}${diff.summary.totalThisMonth - diff.summary.totalLastMonth}
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary);">units</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px;">üìã Items Changed</h3>
                `;

                // Group by status
                const byStatus = {
                    added: diff.items.filter(i => i.status === 'added'),
                    increased: diff.items.filter(i => i.status === 'increased'),
                    decreased: diff.items.filter(i => i.status === 'decreased'),
                    removed: diff.items.filter(i => i.status === 'removed'),
                    unchanged: diff.items.filter(i => i.status === 'unchanged')
                };

                // Render added items
                if (byStatus.added.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #10b981; margin-bottom: 8px;">‚ú® Added (${byStatus.added.length})</h4>`;
                    byStatus.added.forEach(item => {
                        html += `
                            <div style="padding: 8px 12px; background: #f0fdf4; border-left: 3px solid #10b981; margin-bottom: 6px; border-radius: 4px;">
                                <strong>${item.name}</strong> ‚Äî +${item.change} ${item.unit}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Render increased items
                if (byStatus.increased.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #f59e0b; margin-bottom: 8px;">üìà Increased (${byStatus.increased.length})</h4>`;
                    byStatus.increased.forEach(item => {
                        html += `
                            <div style="padding: 8px 12px; background: #fffbeb; border-left: 3px solid #f59e0b; margin-bottom: 6px; border-radius: 4px;">
                                <strong>${item.name}</strong> ‚Äî ${item.lastMonth}‚Üí${item.thisMonth} ${item.unit} (+${item.changePercent}%)
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Render decreased items
                if (byStatus.decreased.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #6366f1; margin-bottom: 8px;">üìâ Decreased (${byStatus.decreased.length})</h4>`;
                    byStatus.decreased.forEach(item => {
                        html += `
                            <div style="padding: 8px 12px; background: #eef2ff; border-left: 3px solid #6366f1; margin-bottom: 6px; border-radius: 4px;">
                                <strong>${item.name}</strong> ‚Äî ${item.lastMonth}‚Üí${item.thisMonth} ${item.unit} (${item.changePercent}%)
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Render removed items
                if (byStatus.removed.length > 0) {
                    html += `<div style="margin-bottom: 12px;">
                        <h4 style="color: #ef4444; margin-bottom: 8px;">‚ùå Removed (${byStatus.removed.length})</h4>`;
                    byStatus.removed.forEach(item => {
                        html += `
                            <div style="padding: 8px 12px; background: #fef2f2; border-left: 3px solid #ef4444; margin-bottom: 6px; border-radius: 4px;">
                                <strong>${item.name}</strong> ‚Äî was ${item.lastMonth} ${item.unit}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div>';

                document.getElementById('diffContent').innerHTML = html;

                // Show insights
                if (insights.insights.length > 0) {
                    this.renderInsights(insights.insights);
                }
            },

            renderInsights(insights) {
                const section = document.getElementById('insightsSection');
                const content = document.getElementById('insightsContent');
                
                section.style.display = 'block';
                
                let html = '';
                insights.forEach(insight => {
                    html += `
                        <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 20px;">${insight.emoji}</span>
                                <strong>${insight.title}</strong>
                            </div>
                            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">${insight.message}</p>
                            <div style="font-size: 12px; color: #667eea; font-weight: 600;">üí° ${insight.action}</div>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            },

            renderHistory() {
                const history = EarlyBirdMonthlyList.getOrderHistory(this.state.customerId, 6);
                const maxQty = Math.max(...history.map(h => h.totalQuantity), 100);

                let html = '';
                history.forEach(item => {
                    const barHeight = (item.totalQuantity / maxQty) * 100;
                    html += `
                        <div style="text-align: center;">
                            <div style="height: 100px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 8px; overflow: hidden;">
                                <div style="width: 100%; height: ${barHeight}%; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 4px 4px 0 0; transition: all 0.3s ease;" title="${item.totalQuantity} items"></div>
                            </div>
                            <div style="font-size: 11px; font-weight: 600;">${item.label}</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">${item.itemCount} items</div>
                        </div>
                    `;
                });

                document.getElementById('historyChart').innerHTML = html || '<p>No history yet</p>';
            },

            switchView(view) {
                this.state.currentView = view;
                
                const listBtn = document.getElementById('listViewBtn');
                const diffBtn = document.getElementById('diffViewBtn');
                const listView = document.getElementById('listViewContent');
                const diffView = document.getElementById('diffViewContent');

                if (view === 'list') {
                    listBtn.style.background = 'var(--primary)';
                    listBtn.style.color = 'white';
                    listBtn.style.borderColor = 'var(--primary)';
                    diffBtn.style.background = '';
                    diffBtn.style.color = '';
                    diffBtn.style.borderColor = '';
                    listView.style.display = 'block';
                    diffView.style.display = 'none';
                } else {
                    listBtn.style.background = '';
                    listBtn.style.color = '';
                    listBtn.style.borderColor = '';
                    diffBtn.style.background = 'var(--primary)';
                    diffBtn.style.color = 'white';
                    diffBtn.style.borderColor = 'var(--primary)';
                    listView.style.display = 'none';
                    diffView.style.display = 'block';
                    this.renderDiffView();
                }
            },

            copyFromLastMonth() {
                const success = EarlyBirdMonthlyList.copyFromPreviousMonth(this.state.customerId, this.state.selectedMonth);
                if (success) {
                    EarlyBirdUtils.showToast('‚úÖ Copied from last month!', 'success');
                    this.loadMonthlyList();
                } else {
                    EarlyBirdUtils.showToast('‚ùå No previous month data to copy', 'error');
                }
            },

            updateQuantity(productId, quantity) {
                const month = EarlyBirdUtils.getMonthKey(this.state.selectedMonth);
                EarlyBirdMonthlyList.updateItemQuantity(this.state.customerId, month, productId, parseInt(quantity));
                EarlyBirdUtils.showToast('‚úÖ Quantity updated', 'success');
            },

            removeItem(productId) {
                if (confirm('Remove this item from your list?')) {
                    const month = EarlyBirdUtils.getMonthKey(this.state.selectedMonth);
                    EarlyBirdMonthlyList.removeItemFromList(this.state.customerId, month, productId);
                    this.loadMonthlyList();
                    EarlyBirdUtils.showToast('‚úÖ Item removed', 'success');
                }
            },

            previousMonth() {
                this.state.selectedMonth = EarlyBirdUtils.addMonths(this.state.selectedMonth, -1);
                this.loadMonthlyList();
            },

            nextMonth() {
                this.state.selectedMonth = EarlyBirdUtils.addMonths(this.state.selectedMonth, 1);
                this.loadMonthlyList();
            },

            currentMonth() {
                this.state.selectedMonth = new Date();
                this.loadMonthlyList();
            },

            openAddItemModal() {
                const products = EarlyBirdUtils.getMockProducts();
                let html = `
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">Select Product</label>
                        <select id="productSelect" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">-- Choose a product --</option>
                `;
                
                products.forEach(p => {
                    html += `<option value="${p.id}">${p.name} ${p.brand ? '(' + p.brand + ')' : ''}</option>`;
                });

                html += `
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="quantityInput" placeholder="Enter quantity" min="1" value="1"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    </div>
                `;

                EarlyBirdUtils.createModal({
                    id: 'addItemModal',
                    title: 'Add Item to List',
                    content: html,
                    footer: `
                        <button class="btn btn-outline" onclick="EarlyBirdUtils.closeModal('addItemModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="monthlyListUI.addItem()">‚úì Add Item</button>
                    `
                });

                EarlyBirdUtils.openModal('addItemModal');
            },

            addItem() {
                const productId = document.getElementById('productSelect').value;
                const quantity = parseInt(document.getElementById('quantityInput').value);

                if (!productId || !quantity) {
                    Toast.error('Please select a product and quantity', 'Validation');
                    return;
                }

                const product = EarlyBirdUtils.getMockProducts().find(p => p.id === productId);
                const month = EarlyBirdUtils.getMonthKey(this.state.selectedMonth);

                EarlyBirdMonthlyList.addItemToList(this.state.customerId, month, {
                    productId: product.id,
                    name: product.name,
                    brand: product.brand,
                    quantity: quantity,
                    unit: product.unit || 'qty'
                });

                this.loadMonthlyList();
                EarlyBirdUtils.closeModal('addItemModal');
                EarlyBirdUtils.showToast('‚úÖ Item added to list', 'success');
            },

            createOrderFromList() {
                // Use backend function to create order from monthly list
                if (typeof EarlyBirdMonthlyList !== 'undefined') {
                    const month = EarlyBirdUtils.getMonthKey(this.state.selectedMonth);
                    const currentUser = EarlyBirdAuth.getCurrentUser();
                    const customerId = currentUser.userId || currentUser.id || this.state.customerId;
                    
                    // Get delivery date (default to today or next day)
                    const deliveryDate = prompt('Enter delivery date (YYYY-MM-DD) or leave blank for today:', 
                        EarlyBirdUtils.getDateString(new Date()));
                    
                    if (deliveryDate === null) return; // User cancelled
                    
                    const order = EarlyBirdMonthlyList.createOrderFromMonthlyList(
                        customerId,
                        month,
                        {
                            customerPhone: currentUser.phone || '',
                            deliveryDate: deliveryDate || EarlyBirdUtils.getDateString(new Date()),
                            deliverySlot: 'am',
                            paymentMethod: 'wallet'
                        }
                    );
                    
                    if (order) {
                        // Refresh UI
                        this.loadMonthlyList();
                    }
                } else {
                    EarlyBirdUtils.showToast('Monthly list module not available', 'error');
                }
            },
            

            filterProducts() {
                const search = document.getElementById('productSearch').value.toLowerCase();
                const monthKey = EarlyBirdUtils.getMonthKey ? EarlyBirdUtils.getMonthKey(this.state.selectedMonth) : '2024-01';
                const list = EarlyBirdMonthlyList && EarlyBirdMonthlyList.state.monthlyLists ? EarlyBirdMonthlyList.state.monthlyLists[`${this.state.customerId}_${monthKey}`] : null;

                if (!list) return;

                const content = document.getElementById('listContent');
                let html = '';

                list.items.forEach(item => {
                    if (item.name.toLowerCase().includes(search) || item.brand.toLowerCase().includes(search)) {
                        html += `
                            <div style="display: grid; grid-template-columns: 1fr 100px 80px 60px; gap: 12px; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
                                <div>
                                    <div style="font-weight: 600;">${item.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${item.brand || 'No brand'}</div>
                                </div>
                                <div>
                                    <input type="number" value="${item.quantity}" 
                                        onchange="monthlyListUI.updateQuantity('${item.productId}', this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                                </div>
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px;">
                                    ${item.unit}
                                </div>
                                <button class="btn btn-sm btn-outline" style="padding: 6px; width: 100%;" 
                                    onclick="monthlyListUI.removeItem('${item.productId}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `;
                    }
                });

                if (html === '') {
                    html = '<p style="text-align: center; color: var(--text-secondary);">No products found</p>';
                }

                content.innerHTML = html;
            }
        };

        // Shared Access UI Controller (Task 7)
        const sharedAccessUI = {
            customerId: 'CUST_001',

            init() {
                const sharedAccess = new EarlyBirdSharedAccess();
                
                // 1. Load current participants
                this.renderParticipants(sharedAccess);
                
                // 2. Load audit trail
                this.renderAuditTrail(sharedAccess);
                
                // 3. Load attribution summary
                this.renderAttributionSummary(sharedAccess);
            },

            renderParticipants(sharedAccess) {
                const config = sharedAccess.getSharedAccountConfig(this.customerId);
                const container = document.getElementById('participantsList');
                
                if (!config) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No shared access configured yet</p>';
                    return;
                }

                let html = '';

                // You (Customer)
                html += `
                    <div style="padding: 16px; background: var(--light); border-radius: 8px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">üë§ You (Account Owner)</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">Full access ‚Ä¢ Can manage all</div>
                        </div>
                        <div style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 700;">OWNER</div>
                    </div>
                `;

                // Support Buddy (if granted)
                if (config.participants.some(p => p.role === 'support')) {
                    const support = config.participants.find(p => p.role === 'support');
                    html += `
                        <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">üë®‚Äçüíº ${support.name} (Support Buddy)</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Granted: ${new Date(support.grantedAt).toLocaleDateString()}</div>
                                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Can: Create orders ‚Ä¢ Update ‚Ä¢ Approve payments</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="sharedAccessUI.revokeAccess('support')">üö´ Revoke</button>
                        </div>
                    `;
                }

                // Delivery Buddy (if granted)
                if (config.participants.some(p => p.role === 'delivery')) {
                    const delivery = config.participants.find(p => p.role === 'delivery');
                    html += `
                        <div style="padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">üöö ${delivery.name} (Delivery Buddy)</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Granted: ${new Date(delivery.grantedAt).toLocaleDateString()}</div>
                                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Can: View orders ‚Ä¢ Update delivery status ‚Ä¢ Mark complete</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="sharedAccessUI.revokeAccess('delivery')">üö´ Revoke</button>
                        </div>
                    `;
                }

                container.innerHTML = html;
            },

            renderAuditTrail(sharedAccess) {
                const log = sharedAccess.getAuditLog(this.customerId).slice(0, 15); // Last 15 actions
                const container = document.getElementById('auditTrail');
                
                if (log.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No activity yet</p>';
                    return;
                }

                let html = '';
                log.forEach(entry => {
                    const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    
                    const roleEmoji = {
                        customer: 'üë§',
                        support: 'üë®‚Äçüíº',
                        delivery: 'üöö',
                        household: 'üë®‚Äçüë©‚Äçüëß',
                        admin: '‚öôÔ∏è'
                    }[entry.role] || '‚ùì';

                    const actionLabel = entry.action.replace(/_/g, ' ').toUpperCase();

                    html += `
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid var(--primary);">
                            <div style="font-size: 13px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <strong>${roleEmoji} ${entry.role}</strong>
                                <span style="font-size: 11px; color: var(--text-tertiary);">${date} at ${time}</span>
                            </div>
                            <div style="font-size: 14px; font-weight: 500;">${actionLabel}</div>
                            ${entry.recordId ? `<div style="font-size: 12px; color: var(--text-secondary);">Record: ${entry.recordId}</div>` : ''}
                            ${entry.reason ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">üìù ${entry.reason}</div>` : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            renderAttributionSummary(sharedAccess) {
                const summary = sharedAccess.getAttributionSummary(this.customerId, 30);
                const container = document.getElementById('attributionSummary');

                if (!summary.byRole || Object.keys(summary.byRole).length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No activity in last 30 days</p>';
                    return;
                }

                let html = '';
                Object.entries(summary.byRole).forEach(([role, data]) => {
                    const roleEmoji = {
                        customer: 'üë§',
                        support: 'üë®‚Äçüíº',
                        delivery: 'üöö'
                    }[role] || '‚ùì';

                    html += `
                        <div style="padding: 16px; background: var(--light); border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${roleEmoji} ${role}</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.count}</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">
                                Actions in past 30 days<br>
                                Last: ${data.lastAction ? new Date(data.lastAction).toLocaleDateString() : 'Never'}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            revokeAccess(role) {
                if (!confirm(`Are you sure you want to revoke access for ${role}?`)) {
                    return;
                }

                const sharedAccess = new EarlyBirdSharedAccess();
                sharedAccess.revokeAccess(this.customerId, role);
                
                EarlyBirdUtils.showToast(`‚úÖ ${role} access revoked`, 'success');
                this.init(); // Refresh UI
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (!EarlyBirdAuth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = EarlyBirdAuth.getCurrentUser();
            if (currentUser.role !== 'customer') {
                Toast.warning('Access denied. Customers only.', 'Access Denied');
                window.location.href = EarlyBirdAuth.getRedirectUrl(currentUser.role);
                return;
            }

            // Initialize payment links
            if (typeof EarlyBirdPaymentLinks !== 'undefined') {
                EarlyBirdPaymentLinks.init();
            }
            
            // Set current user as customer
            EarlyBirdAccessControl.setCurrentUser({
                id: currentUser.userId,
                name: currentUser.name,
                role: 'customer',
                assignedCustomers: [currentUser.userId]
            });
            
            // Update UI based on role
            EarlyBirdAccessControl.updateUIForRole();
            
            // Initialize monthly list when page shows
            if (document.getElementById('monthlylistPage').style.display !== 'none') {
                monthlyListUI.init();
            }
            
            initCalendar();
        });

        // Show page function - displays selected page and hides others
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.style.display = 'block';
            }
            
            // Update nav
            setActiveNav(pageId);
            
            // Page-specific initialization
            if (pageId === 'calendar') {
                setTimeout(() => initCalendar(), 50);
            } else if (pageId === 'orders') {
                switchSubscriptionTab('subscriptions');
            } else if (pageId === 'monthlylist') {
                monthlyListUI.init();
            }
        }

        // Set active navigation item
        function setActiveNav(pageId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-page="${pageId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Tab switching for subscriptions/orders
        function switchSubscriptionTab(tabName) {
            const subscriptionsTab = document.getElementById('subscriptionsTabContent');
            const ordersTab = document.getElementById('ordersTabContent');
            const subscriptionsBtn = document.getElementById('tab-subscriptions');
            const ordersBtn = document.getElementById('tab-orders');
            
            if (tabName === 'subscriptions') {
                subscriptionsTab.style.display = 'block';
                ordersTab.style.display = 'none';
                subscriptionsBtn.classList.add('active');
                ordersBtn.classList.remove('active');
                subscriptionsBtn.style.borderBottomColor = 'var(--primary)';
                subscriptionsBtn.style.color = 'var(--primary)';
                ordersBtn.style.borderBottomColor = 'transparent';
                ordersBtn.style.color = 'var(--text-secondary)';
            } else if (tabName === 'orders') {
                ordersTab.style.display = 'block';
                subscriptionsTab.style.display = 'none';
                ordersBtn.classList.add('active');
                subscriptionsBtn.classList.remove('active');
                ordersBtn.style.borderBottomColor = 'var(--primary)';
                ordersBtn.style.color = 'var(--primary)';
                subscriptionsBtn.style.borderBottomColor = 'transparent';
                subscriptionsBtn.style.color = 'var(--text-secondary)';
            }
        }
    </script>
    <!-- Subscription Integration Scripts -->
    <script src="../features/subscription-integration.js"></script>
</body>
</html>
