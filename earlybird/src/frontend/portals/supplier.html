<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarlyBird Supplier - Demand Forecasting & Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üåÖ</div>
                    <div class="logo-text">
                        <h1>EarlyBird</h1>
                        <p>Supplier Portal</p>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <!-- CALENDAR IS THE SPINE FOR SUPPLIERS TOO -->
                <div class="nav-item active" data-page="calendar" onclick="showPage('calendar')">
                    <span class="nav-icon">üìÖ</span>
                    <span>üìÖ DEMAND CALENDAR</span>
                </div>

                <div style="margin: 12px 20px; height: 1px; background: var(--border);"></div>
                <div style="padding: 12px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary);">Operations</div>

                <div class="nav-item" data-page="forecast" onclick="showPage('forecast')">
                    <span class="nav-icon">üìä</span>
                    <span>7-Day Forecast</span>
                </div>
                <div class="nav-item" data-page="alerts" onclick="showPage('alerts')">
                    <span class="nav-icon">üö®</span>
                    <span>Stock Alerts</span>
                </div>
                <div class="nav-item" data-page="orders" onclick="showPage('orders')">
                    <span class="nav-icon">üì¶</span>
                    <span>Purchase Orders</span>
                </div>
                <div class="nav-item" data-page="inventory" onclick="showPage('inventory')">
                    <span class="nav-icon">üìà</span>
                    <span>Inventory</span>
                </div>

                <div style="margin: 12px 20px; height: 1px; background: var(--border);"></div>
                <div style="padding: 12px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-tertiary);">Finance</div>

                <div class="nav-item" data-page="wallet" onclick="showPage('wallet')">
                    <span class="nav-icon">üí∞</span>
                    <span>My Payments</span>
                </div>
                <div class="nav-item" data-page="ledger" onclick="showPage('ledger')">
                    <span class="nav-icon">üìä</span>
                    <span>Ledger</span>
                </div>
            </nav>

            <div style="padding: 20px; border-top: 1px solid var(--border); margin-top: auto;">
                <div style="background: linear-gradient(135deg, #F77F00 0%, #DC6803 100%); color: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Outstanding Amount</div>
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 2px;">‚Çπ45,200</div>
                    <div style="font-size: 11px; opacity: 0.8;">Due by Jan 27, 2026</div>
                </div>
                <button class="btn btn-outline" style="width: 100%; margin-bottom: 8px;" onclick="showPage('wallet')">
                    üí≥ Withdraw Payment
                </button>
                <div class="user-info" style="margin-bottom: 12px; padding: 12px; background: var(--light); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Logged in as</div>
                    <div class="user-name" style="font-weight: 600; color: var(--primary);">Supplier</div>
                </div>
                <button class="btn btn-outline" style="width: 100%; margin-bottom: 8px;" onclick="EarlyBirdAuth.logout(); window.location.href='login.html'">
                    üö™ Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- DEMAND CALENDAR PAGE (Primary Interface) -->
            <div id="calendarPage" class="page-content">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìÖ Demand Calendar</h2>
                        <p>Your upcoming order forecasts and inventory needs</p>
                    </div>
                </div>

                <!-- Calendar Legend -->
                <div class="heat-map-legend">
                    <span class="legend-title">Demand Volume</span>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="indicator" style="width: 12px; height: 12px; background: #E8F5E9;"></div>
                            <span>Light: 1-50 units</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator" style="width: 12px; height: 12px; background: #66BB6A;"></div>
                            <span>Medium: 51-150 units</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator" style="width: 12px; height: 12px; background: #2E7D32;"></div>
                            <span>High: 151+ units</span>
                        </div>
                        <div class="legend-item">
                            <div class="indicator" style="width: 12px; height: 12px; background: #FF6B6B;"></div>
                            <span>Critical: Stock Alert</span>
                        </div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div id="supplierCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px;"></div>
            </div>

            <!-- FORECAST PAGE -->
            <div id="forecastPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìä 7-Day Forecast</h2>
                        <p>Aggregated demand from all customer orders</p>
                    </div>
                    <button class="btn btn-primary" onclick="generateSupplierOrderFromForecast()">
                        ‚úÖ Generate Purchase Order
                    </button>
                </div>

                <div id="forecastContent" style="margin-top: 20px;"></div>
            </div>

            <!-- ALERTS PAGE -->
            <div id="alertsPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üö® Stock Shortage Alerts</h2>
                        <p>Products needing urgent reorder</p>
                    </div>
                </div>

                <div id="alertsContent" style="margin-top: 20px;"></div>
            </div>

            <!-- ORDERS PAGE -->
            <div id="ordersPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üì¶ Purchase Orders</h2>
                        <p>Orders from EarlyBird admin for your confirmation</p>
                    </div>
                </div>

                <div id="ordersContent" style="margin-top: 20px;"></div>
            </div>

            <!-- WALLET PAGE -->
            <div id="walletPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üí∞ My Payments</h2>
                        <p>Payment tracking and withdrawal</p>
                    </div>
                </div>

                <div id="walletContent" style="margin-top: 20px;"></div>
            </div>

            <!-- INVENTORY PAGE -->
            <div id="inventoryPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <div class="page-header-left">
                        <h2>üìà My Inventory</h2>
                        <p>Current stock levels and reorder points</p>
                    </div>
                    <button class="btn btn-secondary" onclick="showInventoryForm()">
                        ‚ûï Update Stock
                    </button>
                </div>

                <div id="inventoryContent" style="margin-top: 20px;"></div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <!-- Authentication Module -->
    <script src="../../backend/auth.js"></script>

    <script src="../../backend/utils.js"></script>
    <script src="../../backend/calendar.js"></script>
    <script src="../../backend/orders.js"></script>
    <script src="../../backend/supplier.js"></script>
    
    <script>
        // ========== PAGE NAVIGATION ==========
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            
            // Show selected page
            document.getElementById(pageName + 'Page').style.display = 'block';
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });

            // Load page data
            loadPageData(pageName);
        }

        function loadPageData(pageName) {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';

            switch (pageName) {
                case 'calendar':
                    renderSupplierCalendar();
                    break;
                case 'forecast':
                    renderSupplierForecast();
                    break;
                case 'alerts':
                    renderStockAlerts();
                    break;
                case 'orders':
                    renderSupplierOrders();
                    break;
                case 'wallet':
                    renderSupplierWallet();
                    break;
                case 'inventory':
                    renderInventory();
                    break;
            }
        }

        // ========== SUPPLIER CALENDAR ==========
        function renderSupplierCalendar() {
            const calendarEl = document.getElementById('supplierCalendar');
            const today = new Date();
            const days = 30;  // Show 30 days

            calendarEl.innerHTML = '';

            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = EarlyBirdUtils.getDateString(date);

                // Get demand for this date
                const demand = EarlyBirdSupplier.calculateDemandForDate(date);
                const totalDemand = Object.values(demand).reduce((sum, items) => 
                    sum + Object.values(items).reduce((a, b) => a + b, 0), 0);

                // Color code by demand volume
                let bgColor = '#E8F5E9';  // Light green
                if (totalDemand > 150) bgColor = '#2E7D32';  // Dark green
                else if (totalDemand > 50) bgColor = '#66BB6A';  // Medium green

                const dayEl = document.createElement('div');
                dayEl.style.cssText = `
                    padding: 12px;
                    background: ${bgColor};
                    border-radius: 8px;
                    cursor: pointer;
                    text-align: center;
                    border: 1px solid #ddd;
                    transition: all 0.2s;
                `;
                dayEl.innerHTML = `
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px;">
                        ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                    <div style="font-size: 14px; font-weight: 700;">
                        ${totalDemand} units
                    </div>
                `;

                dayEl.onclick = () => showDateDemandDetail(dateStr);
                calendarEl.appendChild(dayEl);
            }
        }

        function showDateDemandDetail(dateStr) {
            // Show modal with detailed demand for this date
            Toast.info(`Detailed demand for ${dateStr} - View analytics`, 'Demand Data');
        }

        // ========== FORECAST VIEW ==========
        function renderSupplierForecast() {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';
            const forecast = EarlyBirdSupplier.getSupplierDemandForecast(supplierId, 7);
            const contentEl = document.getElementById('forecastContent');

            contentEl.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; border: 1px solid #eee;">
                    <h3>7-Day Demand Forecast</h3>
                    <p>Total items needed: <strong>${forecast.totalProducts}</strong></p>
                    
                    <table style="width: 100%; margin-top: 16px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #eee;">
                                <th style="text-align: left; padding: 12px;">Date</th>
                                <th style="text-align: right; padding: 12px;">Items</th>
                                <th style="text-align: left; padding: 12px;">Products</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${forecast.forecastDays.map(day => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px; font-weight: 600;">${day.date} (${day.dayOfWeek})</td>
                                    <td style="text-align: right; padding: 12px; font-size: 18px; font-weight: 700;">${day.totalItems}</td>
                                    <td style="padding: 12px;">
                                        ${Object.entries(day.products).map(([p, q]) => 
                                            `<span style="display: inline-block; background: #f0f0f0; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px;">${p}: ${q}</span>`
                                        ).join('')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${forecast.criticalItems.length > 0 ? `
                        <div style="margin-top: 16px; padding: 12px; background: #FFF3E0; border-radius: 8px; border-left: 4px solid #FF9800;">
                            <h4 style="margin-top: 0;">‚ö†Ô∏è Critical Items (Stock Alert)</h4>
                            ${forecast.criticalItems.map(item => `
                                <div style="font-size: 14px; margin: 8px 0;">
                                    ${item.product}: Need ${item.needed}, Have ${item.onHand} (Shortage: ${item.shortageBy})
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ========== STOCK ALERTS ==========
        function renderStockAlerts() {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';
            const alerts = EarlyBirdSupplier.getInventoryAlerts(supplierId);
            const contentEl = document.getElementById('alertsContent');

            if (alerts.length === 0) {
                contentEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">‚úÖ No stock alerts</div>';
                return;
            }

            contentEl.innerHTML = alerts.map(alert => `
                <div style="background: ${alert.severity === 'RED' ? '#FFEBEE' : '#FFF3E0'}; border-left: 4px solid ${alert.severity === 'RED' ? '#F44336' : '#FF9800'}; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">
                        ${alert.severity === 'RED' ? 'üî¥' : 'üü°'} ${alert.product}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                        <div>On Hand: <strong>${alert.currentStock}</strong></div>
                        <div>Needed: <strong>${alert.demandNext3Days}</strong></div>
                        <div>Shortage: <strong>${alert.shortage}</strong></div>
                        <div>Due: <strong>${alert.dueDate}</strong></div>
                    </div>
                </div>
            `).join('');
        }

        // ========== SUPPLIER ORDERS ==========
        function renderSupplierOrders() {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';
            const orders = EarlyBirdSupplier.state.supplierOrders[supplierId] || [];
            const contentEl = document.getElementById('ordersContent');

            if (orders.length === 0) {
                contentEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No purchase orders yet</div>';
                return;
            }

            contentEl.innerHTML = orders.map(order => `
                <div style="background: white; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 700; font-size: 16px;">${order.id}</div>
                            <div style="color: #666; font-size: 14px;">Total: ‚Çπ${order.totalAmount}</div>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${order.status === 'awaiting_confirmation' ? '#FFF9C4' : order.status === 'confirmed' ? '#C8E6C9' : '#B3E5FC'}; padding: 6px 12px; border-radius: 4px; font-weight: 600;">
                                ${order.status.replace('_', ' ').toUpperCase()}
                            </span>
                        </div>
                    </div>
                    
                    <table style="width: 100%; font-size: 13px; margin-bottom: 12px;">
                        <thead style="border-bottom: 1px solid #eee;">
                            <tr>
                                <th style="text-align: left; padding: 8px;">Product</th>
                                <th style="text-align: right; padding: 8px;">Qty</th>
                                <th style="text-align: right; padding: 8px;">Price</th>
                                <th style="text-align: right; padding: 8px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td style="padding: 8px;">${item.product}</td>
                                    <td style="text-align: right; padding: 8px;">${item.quantity} ${item.unit}</td>
                                    <td style="text-align: right; padding: 8px;">‚Çπ${item.unitPrice}</td>
                                    <td style="text-align: right; padding: 8px;">‚Çπ${item.amount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${order.status === 'awaiting_confirmation' ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="btn btn-primary" onclick="confirmSupplierOrder('${order.id}')">‚úÖ Confirm</button>
                            <button class="btn btn-outline" onclick="Toast.info('Order declined')">‚ùå Decline</button>
                        </div>
                    ` : order.status === 'confirmed' ? `
                        <button class="btn btn-primary" onclick="shipOrder('${order.id}')">üöö Mark as Shipped</button>
                    ` : order.status === 'shipped' ? `
                        <button class="btn btn-primary" onclick="deliverOrder('${order.id}')">‚úÖ Confirm Delivery</button>
                    ` : ''}
                </div>
            `).join('');
        }

        function confirmSupplierOrder(orderId) {
            EarlyBirdSupplier.confirmSupplierOrder(orderId);
            renderSupplierOrders();
            Toast.success('Order confirmed', 'Confirmed');
        }

        function shipOrder(orderId) {
            EarlyBirdSupplier.shipSupplierOrder(orderId);
            renderSupplierOrders();
            Toast.info('Order shipped', 'Shipped');
        }

        function deliverOrder(orderId) {
            EarlyBirdSupplier.confirmOrderDelivery(orderId);
            renderSupplierOrders();
            Toast.success('Delivery confirmed', 'Delivered');
        }

        // ========== SUPPLIER WALLET ==========
        function renderSupplierWallet() {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';
            const wallet = EarlyBirdSupplier.getSupplierWallet(supplierId);
            const contentEl = document.getElementById('walletContent');

            if (!wallet) {
                contentEl.innerHTML = '<div>No wallet data</div>';
                return;
            }

            contentEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #66BB6A 0%, #2E7D32 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Available Balance</div>
                        <div style="font-size: 32px; font-weight: 700;">‚Çπ${wallet.balance}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FF9800 0%, #E65100 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Outstanding Amount</div>
                        <div style="font-size: 32px; font-weight: 700;">‚Çπ${wallet.totalOutstanding}</div>
                    </div>
                </div>

                <div style="background: white; border: 1px solid #eee; border-radius: 8px; padding: 16px;">
                    <h3>Recent Transactions</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="border-bottom: 1px solid #eee;">
                            <tr>
                                <th style="text-align: left; padding: 12px;">Type</th>
                                <th style="text-align: left; padding: 12px;">Amount</th>
                                <th style="text-align: left; padding: 12px;">Date</th>
                                <th style="text-align: left; padding: 12px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${wallet.transactions.slice(-10).reverse().map(txn => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;">${txn.type}</td>
                                    <td style="padding: 12px; font-weight: 600;">‚Çπ${txn.amount}</td>
                                    <td style="padding: 12px;">${new Date(txn.timestamp).toLocaleDateString()}</td>
                                    <td style="padding: 12px;"><span style="background: #C8E6C9; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${txn.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ========== INVENTORY ==========
        function renderInventory() {
            const supplierId = localStorage.getItem('currentSupplier') || 'SUP_001';
            const supplier = EarlyBirdSupplier.getSupplier(supplierId);
            const inventory = EarlyBirdSupplier.getInventory(supplierId);
            const contentEl = document.getElementById('inventoryContent');

            if (!supplier || !supplier.products || supplier.products.length === 0) {
                contentEl.innerHTML = '<div>No products configured</div>';
                return;
            }

            contentEl.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead style="background: #f5f5f5; border-bottom: 2px solid #eee;">
                        <tr>
                            <th style="text-align: left; padding: 12px;">Product</th>
                            <th style="text-align: center; padding: 12px;">Current Stock</th>
                            <th style="text-align: center; padding: 12px;">Reorder Level</th>
                            <th style="text-align: center; padding: 12px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${supplier.products.map(product => {
                            const inv = inventory[product.name] || { stock: 0, reorderLevel: 50 };
                            const status = inv.stock <= inv.reorderLevel ? 'LOW' : 'OK';
                            return `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px; font-weight: 600;">${product.name}</td>
                                    <td style="text-align: center; padding: 12px;">${inv.stock} ${product.unit}</td>
                                    <td style="text-align: center; padding: 12px;">${inv.reorderLevel}</td>
                                    <td style="text-align: center; padding: 12px;">
                                        <span style="background: ${status === 'LOW' ? '#FFEBEE' : '#E8F5E9'}; color: ${status === 'LOW' ? '#C62828' : '#2E7D32'}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                            ${status}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (!EarlyBirdAuth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = EarlyBirdAuth.getCurrentUser();
            if (currentUser.role !== 'supplier' && currentUser.role !== 'admin') {
                Toast.warning('Access denied. Suppliers only.', 'Access Denied');
                window.location.href = 'login.html';
                return;
            }

            EarlyBirdSupplier.init();
            EarlyBirdSupplier.generateDemandForecast(7);
            EarlyBirdSupplier.checkInventoryLevels();
            showPage('calendar');
        });
    </script>
</body>
</html>
